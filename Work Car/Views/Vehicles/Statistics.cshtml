@{
    ViewData["Title"] = "行車歷程統計";
    Layout = "_Layout";
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .tabs {
        display: flex;
        gap: 8px;
        margin: 12px 0
    }

    .tab {
        padding: 10px 18px;
        border: 1px solid #dbeafe;
        border-radius: 10px;
        background: #f4f7ff;
        color: #1e3a8a;
        cursor: pointer;
        font-weight: 600
    }

        .tab.active {
            background: #fff;
            border-bottom-color: #fff;
            box-shadow: 0 -2px 0 0 #fff inset
        }

    .filters {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 14px
    }

        .filters .chip {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #fff;
            border: 1px solid #dbeafe;
            border-radius: 999px;
            padding: 6px 10px
        }

        .filters input, .filters select {
            border: 0;
            outline: 0;
            background: transparent;
            font-size: 14px;
            min-width: 120px
        }

    .search-btn {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        border: 1px solid #c7d2fe;
        background: #fff;
        color: #1e40af;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer
    }

    table {
        width: 100%;
        border-collapse: collapse
    }

    thead th {
        background: #e0edff;
        padding: 10px 12px;
        text-align: left;
        font-size: 13px
    }

    tbody td {
        padding: 10px 12px;
        border-bottom: 1px solid #eef2ff
    }

    tbody tr:nth-child(2n) {
        background: #fcfcff
    }

    tfoot td {
        padding: 10px 12px;
        background: #f8fbff;
        font-weight: 700
    }

    .mono {
        font-variant-numeric: tabular-nums
    }

    .badge {
        display: inline-block;
        border: 1px solid #c7d2fe;
        background: #eef2ff;
        color: #1e40af;
        border-radius: 999px;
        padding: 2px 10px;
        font-size: 12px;
        font-weight: 600
    }

    .right {
        text-align: right
    }
</style>

<div id="app" class="wrap" v-cloak>
    <!-- 分頁籤 -->
    <div class="tabs">
        <a class="tab" :class="{active: currentTab==='table'}" @@click ="currentTab='table'">行車歷程</a>
        <a class="tab" :class="{active: currentTab==='chart'}" @@click ="currentTab='chart'">統計圖</a>
    </div>

    <!-- 行車歷程表格 -->
    <div v-show="currentTab==='table'">
        <!-- 篩選列 -->
        <div class="filters">
            <div class="chip">
                <input type="date" v-model="q.dateFrom">
                <span>~</span>
                <input type="date" v-model="q.dateTo">
            </div>
            <div class="chip">
                <select v-model="q.driverId" @@change ="reload">
                    <option :value="null">駕駛人（全部）</option>
                    <option v-for="d in drivers" :key="d.id" :value="d.id">{{ d.name }}</option>
                </select>
            </div>
            <div class="chip"><input type="text" v-model.trim="q.plate" placeholder="車輛車號"></div>
            <div class="chip"><input type="text" v-model.trim="q.applicant" placeholder="申請人"></div>
            <div class="chip"><input type="text" v-model.trim="q.dept" placeholder="申請單位"></div>
            <button class="search-btn" @@click ="reload"><i class="fa-solid fa-magnifying-glass"></i></button>
        </div>

        <div class="card">
            <div class="card-bd table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>行車日期</th>
                            <th>駕駛人</th>
                            <th>車輛車號</th>
                            <th>申請單位</th>
                            <th>申請人</th>
                            <th>行駛里程</th>
                            <th>行駛趟次</th>
                            <th>長差/短差</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="r in rows" :key="r.id">
                            <td class="mono">{{ rocDate(r.driveDate) }}</td>
                            <td>{{ r.driverName }}</td>
                            <td><span class="badge">{{ r.plateNo }}</span></td>
                            <td>{{ shortDept(r.applicantDept) }}</td>
                            <td>{{ r.applicantName }}</td>
                            <td class="mono">{{ r.km }}</td>
                            <td class="mono">{{ r.trips }}</td>
                            <td>{{ r.longShort || '—' }}</td>
                        </tr>
                        <tr v-if="!rows.length">
                            <td colspan="8" style="text-align:center;color:#94a3b8;padding:16px">目前沒有資料</td>
                        </tr>
                    </tbody>
                    <tfoot v-if="rows.length">
                        <tr>
                            <td colspan="5" class="right">總計</td>
                            <td class="mono">{{ sumKm }}</td>
                            <td class="mono">{{ sumTrips }}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- 統計圖 -->
    <div v-show="currentTab==='chart'">
        <div class="card" style="margin-top:14px; padding:20px">
            <h3 style="margin-bottom:12px">駕駛人行駛里程比較</h3>
            <canvas id="driverChart" height="120"></canvas>

            <h3 style="margin:24px 0 12px">車輛行駛里程比較</h3>
            <canvas id="vehicleChart" height="120"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
          setup(){
            const currentTab = ref('table'); // 預設顯示表格
            const q = ref({ dateFrom:'', dateTo:'', driverId:null, plate:'', applicant:'', dept:'' });
            const rows = ref([]);
            const drivers = ref([]);

            const pad = n=>String(n).padStart(2,'0');
            const rocDate = d=>{
              const x=new Date(d); if(isNaN(x)) return '';
              return `${x.getFullYear()-1911}/${pad(x.getMonth()+1)}/${pad(x.getDate())}`;
            };
            function shortDept(dept){
              if(!dept) return '';
              const parts=dept.split('/').map(x=>x.trim()).filter(Boolean);
              if(parts.length<=2) return dept;
              return `${parts[0]} / ${parts[parts.length-1]}`;
            }

            const sumKm = computed(()=> rows.value.reduce((a,b)=>a+(Number(b.km)||0),0));
            const sumTrips = computed(()=> rows.value.reduce((a,b)=>a+(Number(b.trips)||0),0));

            async function reload(){
              const res = await axios.get('/Vehicles/TripStats',{ params:q.value });
              rows.value = Array.isArray(res.data) ? res.data : [];
              drawCharts();
            }

            async function loadDrivers(){
              const res = await axios.get('/Drivers/Records');
              drivers.value = (res.data||[]).map(x=>({ id:x.driverId||x.id, name:x.driverName||x.name }));
            }

            let driverChart, vehicleChart;
            function drawCharts(){
              if(!rows.value.length) return;

              // 駕駛
              const byDriver={};
              rows.value.forEach(r=>{ byDriver[r.driverName]=(byDriver[r.driverName]||0)+(Number(r.km)||0); });
              const driverCtx=document.getElementById('driverChart');
              if(driverChart) driverChart.destroy();
              driverChart=new Chart(driverCtx,{ type:'bar', data:{
                labels:Object.keys(byDriver),
                datasets:[{label:'里程 (km)', data:Object.values(byDriver), backgroundColor:'#3b82f6'}]
              }});

              // 車輛
              const byVehicle={};
              rows.value.forEach(r=>{ byVehicle[r.plateNo]=(byVehicle[r.plateNo]||0)+(Number(r.km)||0); });
              const vehicleCtx=document.getElementById('vehicleChart');
              if(vehicleChart) vehicleChart.destroy();
              vehicleChart=new Chart(vehicleCtx,{ type:'bar', data:{
                labels:Object.keys(byVehicle),
                datasets:[{label:'里程 (km)', data:Object.values(byVehicle), backgroundColor:'#10b981'}]
              }});
            }

            onMounted(async()=>{ await loadDrivers(); await reload(); });

            return { currentTab, q, rows, drivers, reload, rocDate, shortDept, sumKm, sumTrips };
          }
        }).mount('#app');
    </script>
}
