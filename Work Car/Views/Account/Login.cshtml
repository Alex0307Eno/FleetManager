@{
    ViewData["Title"] = "登入";
    Layout = "_Layout";
}
<div class="container" style="max-width:380px;margin:72px auto;">
    <div class="card shadow-sm" style="padding:20px;">
        <h1 class="h5 text-center mb-3">系統登入</h1>

        <!-- 提示訊息 -->
        <div id="msg" class="alert d-none" role="alert"></div>

        <form id="loginForm" autocomplete="off" novalidate>
            <div class="mb-3">
                <label class="form-label">帳號</label>
                <input id="username" class="form-control" required />
            </div>
            <div class="mb-3">
                <label class="form-label">密碼</label>
                <input id="password" type="password" class="form-control" required />
            </div>
            <button id="btnLogin" type="submit" class="btn btn-primary w-100">登入</button>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        (() => {
          const form = document.getElementById('loginForm');
          const btn  = document.getElementById('btnLogin');
          const msg  = document.getElementById('msg');

          function show(kind, text){
            msg.className = 'alert alert-' + kind;
            msg.textContent = text;
            msg.classList.remove('d-none');
          }

          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userName = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!userName || !password) {
              show('warning', '請輸入帳號與密碼');
              return;
            }

            btn.disabled = true;
            btn.textContent = '登入中…';

            try {
              // 同網域預設會帶 cookie；若跨網域請加 { withCredentials: true }
              const { data } = await axios.post('/api/auth/login', { userName, password });

              const url = data?.redirectUrl || '/';
              show('success', data?.message || '登入成功，將跳轉…');
              setTimeout(() => { window.location.href = url; }, 300);
            } catch (err) {
              // 從伺服器取錯誤訊息；沒有就顯示狀態碼
              const msgText =
                err?.response?.data?.message ||
                (`登入失敗${err?.response?.status ? `（${err.response.status}）` : ''}`);
              show('danger', msgText);
            } finally {
              btn.disabled = false;
              btn.textContent = '登入';
            }
          });
        })();
    </script>
}
