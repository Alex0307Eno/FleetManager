@{
    ViewData["Title"] = "駕駛員基本資料";
}


<head>
    
    <title>@ViewData["Title"]</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="~/css/Driver/Index.css" rel="stylesheet" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</head>
<body>


    <div class="wrap">
        <!-- 頁首工具列 -->
        <div class="topbar d-flex justify-content-between align-items-center">
            <!-- 左邊：標題 -->
            <h1 class="m-0">駕駛員管理 ＞ 駕駛員基本資料</h1>

            <!-- 右邊：操作按鈕 -->
            <div class="d-flex gap-2">
                <a class="btn btn-warning" href="/Drivers/Create">
                    <i class="fa-solid fa-plus"></i> 新增
                </a>
            </div>
        </div>

        <!-- Vue app -->
        <main id="app" v-cloak>
            <div >
                <div class="card-hd">清單</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>姓名</th>
                                <th>身分證字號</th>
                                <th>出生年月日</th>
                                <th>戶籍地址</th>
                                <th>聯絡地址</th>
                                <th>市話</th>
                                <th>行動電話</th>
                                <th>緊急聯絡人</th>
                                <th style="width:100px;text-align:right;">功能</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="d in drivers" :key="d.driverId">
                          
                                <td>{{ d.driverName || '—' }}</td>
                                <td>{{ d.nationalId || '—' }}</td>
                                <td>{{ rocDate(d.birthDate) }}</td>
                                <td>{{ d.householdAddress || '—' }}</td>
                                <td>{{ d.contactAddress || '—' }}</td>
                                <td>{{ d.phone || '—' }}</td>
                                <td>{{ d.mobile || '—' }}</td>
                                <td>
                                    <span v-if="d.emergencyContactName || d.emergencyContactPhone">
                                        {{ d.emergencyContactName }} {{ d.emergencyContactPhone }}
                                    </span>
                                    <span v-else>—</span>
                                </td>
                                <td>
                                    <div class="actions">
                                        <button class="icon-btn view" title="檢視" @@click="viewDriver(d.driverId)">
                                            <i class="fa-solid fa-eye"></i>
                                        </button>
                                        <a :href="`/api/Drivers/Edit/${d.driverId}`" class="icon-btn edit" title="編輯">
                                            <i class="fa-solid fa-pen-to-square"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <tr v-if="!drivers.length">
                                <td colspan="9" style="text-align:center;color:#94a3b8;padding:16px;">目前沒有資料</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 檢視 Modal -->
            <div v-if="viewModalOpen" class="modal-mask">
                <div class="modal-container" style="max-width:700px;width:90%;">
                    <h3 class="modal-title">駕駛員詳細資料</h3>

                    <table class="table-detail">
                        <tr>
                            <th>姓名</th>
                            <td>{{ currentDriver.driverName }}</td>
                        </tr>
                        <tr>
                            <th>身分證字號</th>
                            <td>{{ currentDriver.nationalId }}</td>
                        </tr>
                        <tr>
                            <th>出生年月日</th>
                            <td>{{ rocDate(currentDriver.birthDate) }}</td>
                        </tr>
                        <tr>
                            <th>戶籍地址</th>
                            <td>{{ currentDriver.householdAddress }}</td>
                        </tr>
                        <tr>
                            <th>聯絡地址</th>
                            <td>{{ currentDriver.contactAddress }}</td>
                        </tr>
                        <tr>
                            <th>市話</th>
                            <td>{{ currentDriver.phone }}</td>
                        </tr>
                        <tr>
                            <th>行動電話</th>
                            <td>{{ currentDriver.mobile }}</td>
                        </tr>
                        <tr>
                            <th>緊急聯絡人</th>
                            <td>{{ currentDriver.emergencyContactName }} {{ currentDriver.emergencyContactPhone }}</td>
                        </tr>
                    </table>

                    <div class="modal-actions" style="margin-top:12px;text-align:right">
                        <button class="btn" @@click="viewModalOpen=false">關閉</button>
                    </div>
                </div>
            </div>

        </main>
    </div>


    <script>
        const { createApp, ref, onMounted } = Vue
        createApp({
          setup(){
            const drivers = ref([])
            // 民國日期格式化
            function rocDate(d){
              if(!d) return ''
              const dt = new Date(d)
              if(isNaN(dt)) return ''
              return `${dt.getFullYear()-1911}/${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getDate()).padStart(2,'0')}`
            }
            // 載入駕駛員資料
            async function load(){
              try{
                const res = await axios.get('/api/Drivers/Records')
                drivers.value = res.data || []
              }catch(e){
                console.error("載入失敗", e)
              }
            }
        const viewModalOpen = ref(false)
        const currentDriver = ref({})
        // 檢視駕駛員詳細資料
        async function viewDriver(id){
          try{
            const res = await axios.get(`/api/Drivers/Details/${id}`) 
            currentDriver.value = res.data
            viewModalOpen.value = true
          }catch(e){
            console.error("讀取駕駛員失敗", e)
            alert("讀取失敗")
          }
        }
        // 切換今日出勤狀態
        async function toggleAttendance(d) {
          const present = !!d.isPresentToday;
          try {
            await axios.post('/api/Drivers/SetAttendanceToday', {
              driverId: d.driverId,
              isPresent: present,
              reason: present ? null : '請假'
            });
          } catch (e) {
            d.isPresentToday = !present; // 還原 UI 
            const msg = e.response?.data || e.message || '更新失敗';
            console.error('更新出勤狀態失敗', msg);
            alert(msg);
          }
        }


            onMounted(load)
        return {
          //狀態 & 資料
          drivers,
          rocDate,

          //Modal 狀態
          viewModalOpen,
          currentDriver,

          //操作方法
          viewDriver,
          toggleAttendance
        };
                  }
        }).mount('#app')
    </script>
</body>
