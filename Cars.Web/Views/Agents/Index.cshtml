@{
    ViewData["Title"] = "駕駛員管理 > 代理人員";
    Layout = "_Layout";
}
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
<link href="~/css/Driver/Agent.css" rel="stylesheet" />

<div id="app" v-cloak>
    <div class="topbar">
        <div class="muted" style="margin-bottom:12px;">駕駛員管理 <span style="color:#fff;">&gt;</span> <b>代理人員</b></div>
        <div class="d-flex gap-2">
            <a class="btn btn-warning" href="/Agents/Create">
                <i class="fa-solid fa-plus"></i> 新增
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab" :class="{active: activeTab==='records'}" @@click ="activeTab='records'">代理紀錄</div>
        <div class="tab" :class="{active: activeTab==='profile'}" @@click ="switchToProfile()">代理人員基本資料</div>
    </div>

    <!-- 代理紀錄 -->
    <div v-show="activeTab==='records'" class="content">
        <div class="table-card">
            <table class="table">
                <thead>
                    <tr>
                        <th>代理人姓名</th>
                        <th>代理期間</th>
                        <th>被代理人</th>
                        <th>代理原因</th>
                        <th>行駛趟數</th>
                        <th>行駛公里數</th>
                        <th class="td-actions">功能</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="r in records" :key="r.id">
                        <td>{{ r.agentName }}</td>
                        <td>{{ r.period }}</td>
                        <td>{{ r.principalName }}</td>
                        <td>{{ r.reason }}</td>
                        <td>{{ r.tripCount }}</td>
                        <td>{{ r.distanceKm }}</td>
                        <td>
                            <a class="icon-btn view" href="javascript:void(0)" @@click ="viewRecord(r)">
                                <i class="fa-regular fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 代理人員基本資料 -->
    <div v-show="activeTab==='profile'" class="content">
        <div class="table-card">
            <table class="table">
                <thead>
                    <tr>
                        <th>姓名</th>
                        <th>身分證字號</th>
                        <th>出生年月日</th>
                        <th>戶籍地址</th>
                        <th>聯絡地址</th>
                        <th>電話</th>
                        <th>行動電話</th>
                        <th>緊急聯絡人</th>
                        <th>聯絡人電話</th>
                        <th class="td-actions">功能</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="p in profiles" :key="p.id">
                        <td>{{ p.name }}</td>
                        <td>{{ p.nationalId }}</td>
                        <td>{{ p.birthRoc }}</td>
                        <td>{{ p.household }}</td>
                        <td>{{ p.contact }}</td>
                        <td>{{ p.phone }}</td>
                        <td>{{ p.mobile }}</td>
                        <td>{{ p.emergency }}</td>
                        <td>{{ p.emergencyPhone }}</td>
                        <td>
                            <a class="icon-btn view" @@click ="viewProfile(p)">
                                <i class="fa-regular fa-eye"></i>
                            </a>
                            <a class="icon-btn edit" :href="`/Agents/Edit/${p.driverId}`">
                                <i class="fa-regular fa-pen-to-square"></i>
                            </a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal: Record -->
    <div class="modal-mask" v-if="showRecordModal">
        <div class="modal-container" style="max-width:700px;width:90%;">
            <h3>代理紀錄詳細資料</h3>
            <table class="table-detail">
                <tr><th>代理人姓名</th><td>{{ currentRecord.agentName }}</td></tr>
                <tr><th>被代理人</th><td>{{ currentRecord.principalName }}</td></tr>
                <tr><th>代理原因</th><td>{{ currentRecord.reason }}</td></tr>
                <tr><th>代理期間</th><td>{{ currentRecord.period }}</td></tr>
                <tr><th>行駛趟數</th><td>{{ currentRecord.tripCount }}</td></tr>
                <tr><th>行駛公里數</th><td>{{ currentRecord.distanceKm }}</td></tr>
            </table>
            <div style="text-align:right">
                <button class="btn" @@click ="showRecordModal=false">關閉</button>
            </div>
        </div>
    </div>

    <!-- Modal: Profile -->
    <div class="modal-mask" v-if="showProfileModal">
        <div class="modal-container" style="max-width:700px;width:90%;">
            <h3>代理人員詳細資料</h3>
            <table class="table-detail">
                <tr><th>姓名</th><td>{{ currentProfile.name }}</td></tr>
                <tr><th>身分證</th><td>{{ currentProfile.nationalId }}</td></tr>
                <tr><th>生日</th><td>{{ currentProfile.birthRoc }}</td></tr>
                <tr><th>戶籍地址</th><td>{{ currentProfile.household }}</td></tr>
                <tr><th>聯絡地址</th><td>{{ currentProfile.contact }}</td></tr>
                <tr><th>電話</th><td>{{ currentProfile.phone }}</td></tr>
                <tr><th>手機</th><td>{{ currentProfile.mobile }}</td></tr>
                <tr><th>緊急聯絡人</th><td>{{ currentProfile.emergency }}</td></tr>
                <tr><th>聯絡人電話</th><td>{{ currentProfile.emergencyPhone }}</td></tr>
            </table>
            <div style="text-align:right">
                <button class="btn" @@click ="showProfileModal=false">關閉</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                activeTab: 'records',
                records: [],
                profiles: [],
                showRecordModal: false,
                showProfileModal: false,
                currentRecord: {},
                currentProfile: {},
                profilesLoaded: false
            }
        },
        mounted() {
            this.loadRecords();
        },
        methods: {
            loadRecords() {
                axios.get('/api/Agents/Records')
                    .then(res => this.records = res.data)
                    .catch(() => alert("讀取紀錄失敗"));
            },
            loadProfiles() {
                if (this.profilesLoaded) return;
                axios.get('/api/Agents/Profiles')
                    .then(res => {
                        this.profiles = res.data;
                        this.profilesLoaded = true;
                    })
                    .catch(() => alert("讀取 Profiles 失敗"));
            },
            switchToProfile() {
                this.activeTab = 'profile';
                this.loadProfiles();
            },
            viewRecord(r) {
                this.currentRecord = r;
                this.showRecordModal = true;
            },
            viewProfile(p) {
                this.currentProfile = p;
                this.showProfileModal = true;
            }
        }
    }).mount("#app");
</script>
